<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="https://www.w3schools.com/w3css/3/w3.css" />
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script src="webadb.js"></script>
</head>
<body>
    <div id="nowebusb" class="w3-container w3-block w3-sand w3-border w3-border-red w3-left-align w3-round" style="visibility: hidden">
      <p>
        WebUSB API is disabled or not supported by your browser.<br>
        Chrome users may visit chrome://flags/#enable-experimental-web-platform-features
        (<a href="https://developers.google.com/web/updates/2016/03/access-usb-devices-on-the-web#before_we_start">more details</a>).
      </p>
    </div>
    <div id="disclaimer" class="w3-container w3-block w3-sand w3-border w3-border-orange w3-left-align w3-round" style="visibility: hidden">
      <p>
        This page is supposed to access a device connected to your PC via USB.
        The whole elaboration is done locally and under your complete responsibility.
      </p><p>
        <button onclick="accept_disclaimer()">I understand and accept</button>
        <a href="https://github.com/cavokz/cavokz.github.io/blob/master/usb/index.html">Look at the source code</a>
      </p>
    </div>
    <div id="connect" class="w3-container w3-block w3-sand w3-border w3-border-blue w3-left-align w3-round" style="visibility: hidden">
      <p>
        <button id="connect_btn" onclick="connect_usb()" disabled>Connect device</button>
        <span id="connect_message" style="visibility: hidden">{{message}}</span>
      </p>
    </div>
    <div id="execute" class="w3-container w3-block w3-sand w3-border w3-border-blue w3-left-align w3-round" style="visibility: hidden">
      <p>
        <button id="execute_btn" type="submit" onclick="execute_usb()" disabled>Execute</button>
        <input id="execute_cmd" type="text" value="uname -a" />
        <span id="execute_message" style="visibility: hidden">{{message}}</span>
      </p>
    </div>
    <div id="cancel" class="w3-container w3-block w3-sand w3-border w3-border-blue w3-left-align w3-round" style="visibility: hidden">
      <p>
        <pre id="execute_output" style="font-size: 0.75em"></pre>
        <button id="cancel_btn" onclick="cancel_usb()">Cancel</button>
        <span id="cancel_message" style="visibility: hidden">{{message}}</span>
      </p>
    </div>
    <span id="bottom"></span>

    <script>
var params = location.search.substring(1).split("&");
var adb = null;
var shell = null;

for (p in params) {
	var pair = params[p].split("=");
	if (pair[0] == "debug" && pair[1] == "yes")
		Adb.Opt.debug = true;
	if (pair[0] == "dump" && pair[1] == "yes")
		Adb.Opt.dump = true;
}

function setVisibilityById(id, visibility)
{
	let node = document.getElementById(id);
	if (node != null)
		node.style.visibility = visibility;
}

function removeElementById(id)
{
	let node = document.getElementById(id);
	if (node != null)
		node.parentNode.removeChild(node);
}

async function connect_usb()
{
	setVisibilityById("message", "hidden");

	try {
		let webusb = await Adb.open("WebUSB");
		let message = webusb.device.productName + " (" + webusb.device.manufacturerName + ")";
		w3.displayObject("connect_message", { message: message });
		setVisibilityById("connect_message", "visible");

		adb = await webusb.connectAdb("host::");
		setVisibilityById("execute", "visible");
		document.getElementById('execute_btn').disabled = false;
		document.getElementById('connect_btn').disabled = true;
	}
	catch(error) {
		console.log(error);
		w3.displayObject("connect_message", { message: error.message });
		setVisibilityById("connect_message", "visible");
	}
}

async function execute_usb()
{
	let command = document.getElementById('execute_cmd');
	let output = document.getElementById('execute_output');
	let bottom = document.getElementById('bottom');

	try {
		shell = await adb.open("shell:" + command.value);
		setVisibilityById("execute_output", "visible");
		setVisibilityById("cancel", "visible");
		document.getElementById('cancel_btn').disabled = false;
		document.getElementById('execute_btn').disabled = true;
		document.getElementById('execute_cmd').disabled = true;
		output.innerHTML = "";

		r = await shell.receive();
		while (r.cmd == "WRTE") {
			if (r.data != null) {
				let decoder = new TextDecoder();
				output.innerHTML += decoder.decode(r.data);
				bottom.scrollIntoView();
			}

			shell.send("OKAY");
			r = await shell.receive();
		}

		shell.close();
		shell = null;

		document.getElementById('cancel_btn').disabled = true;
		document.getElementById('execute_btn').disabled = false;
		document.getElementById('execute_cmd').disabled = false;
	}
	catch(error) {
		console.log(error);
		w3.displayObject("execute_message", { message: error.message });
		setVisibilityById("execute_message", "visible");
	}
}

async function cancel_usb()
{
	if (shell != null) {
		shell.close();
		document.getElementById('cancel_btn').disabled = true;
	}
}

function accept_disclaimer()
{
	removeElementById('disclaimer');
	document.getElementById('connect_btn').disabled = false;
}

if (navigator.usb) {
	setVisibilityById("disclaimer", "visible");
	setVisibilityById("connect", "visible");
	removeElementById("nowebusb");

	if (location.host == "127.0.0.1")
		accept_disclaimer();
} else {
	setVisibilityById("nowebusb", "visible");
}
    </script>
</body>
</html>
